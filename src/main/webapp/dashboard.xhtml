<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      xmlns:sec="http://www.springframework.org/security/tags">

<ui:composition template="/templates/main.xhtml">
    <ui:define name="title">Dashboard</ui:define>
    <ui:define name="content">
        <sec:authorize ifAllGranted="GENERAL_MANAGER">
            <p:commandButton id="register-parcel" value="#{msg['registerParcel']}"/>

            <div id="parcel-registration">
                <h:form id="addItemForm">
                    <p:panelGrid columns="2" cellpadding="5">
                        <f:facet name="header">
                            <h3>#{msg['itemInfo']}</h3>
                        </f:facet>

                        <p:outputLabel value="#{msg['name']}:"/>
                        <p:inputText value="${parcelBean.item.nameBought}" size="22"/>

                        <p:outputLabel value="#{msg['description']}:"/>
                        <p:inputTextarea value="#{parcelBean.item.descriptionBought}" rows="5" cols="24"/>

                        <p:outputLabel value="#{msg['buyingPrice']}:"/>
                        <p:spinner min="0" stepFactor="1" value="${parcelBean.item.buyingPrice}" prefix="$" size="20">
                            <f:convertNumber minFractionDigits="2" maxFractionDigits="2" groupingUsed="false"/>
                        </p:spinner>

                        <p:outputLabel value="#{msg['sellingPrice']}:"/>
                        <p:spinner min="0" stepFactor="1" value="${parcelBean.item.sellingPrice}" prefix="$" size="20">
                            <f:convertNumber minFractionDigits="2" maxFractionDigits="2" groupingUsed="false"/>
                        </p:spinner>

                        <p:outputLabel value="#{msg['weight']}:"/>
                        <p:spinner min="0" stepFactor="0.1" value="${parcelBean.item.weightBought}"
                                   suffix=" #{msg['t']}"
                                   size="20"/>

                        <f:facet name="footer">
                            <p:commandButton styleClass="add-item-button" value="#{msg['add']}"
                                             action="${parcelBean.addItemToParcel()}"
                                             update="addItemForm, :addParcelForm:numberOfItems, :itemsEditable"/>
                        </f:facet>
                    </p:panelGrid>
                </h:form>

                <br/>

                <h:form id="itemsEditable">
                    <p:dataTable var="item" value="${parcelBean.parcel.items}" editable="true">
                        <f:facet name="header">
                            <h3>#{msg['parcelItems']}</h3>
                        </f:facet>
                        <p:column headerText="#{msg['name']}" sortBy="${item.nameBought}">
                            <p:cellEditor>
                                <f:facet name="output">
                                    <h:outputText value="${item.nameBought}"/>
                                </f:facet>
                                <f:facet name="input">
                                    <p:inputText value="${item.nameBought}"/>
                                </f:facet>
                            </p:cellEditor>
                        </p:column>

                        <p:column headerText="#{msg['weight']}" sortBy="${item.weightBought}">
                            <p:cellEditor>
                                <f:facet name="output">
                                    <h:outputText value="${item.weightBought}">
                                        <f:convertNumber minFractionDigits="1" maxFractionDigits="1"/>
                                    </h:outputText>
                                </f:facet>
                                <f:facet name="input">
                                    <p:spinner min="0" stepFactor="0.1" value="${item.weightBought}"
                                               suffix=" #{msg['t']}"/>
                                </f:facet>
                            </p:cellEditor>
                        </p:column>

                        <p:column headerText="#{msg['description']}" sortBy="${item.descriptionBought}">
                            <p:cellEditor>
                                <f:facet name="output">
                                    <h:outputText value="${item.descriptionBought}"/>
                                </f:facet>
                                <f:facet name="input">
                                    <p:inputText value="${item.descriptionBought}"/>
                                </f:facet>
                            </p:cellEditor>
                        </p:column>

                        <p:column headerText="#{msg['buyingPrice']}" sortBy="${item.buyingPrice}">
                            <p:cellEditor>
                                <f:facet name="output">
                                    <h:outputText value="$${item.buyingPrice}">
                                        <f:convertNumber minFractionDigits="2" maxFractionDigits="2"/>
                                    </h:outputText>
                                </f:facet>
                                <f:facet name="input">
                                    <p:spinner min="0" stepFactor="1" value="${item.buyingPrice}" prefix="$">
                                        <f:convertNumber minFractionDigits="2" maxFractionDigits="2"/>
                                    </p:spinner>
                                </f:facet>
                            </p:cellEditor>
                        </p:column>

                        <p:column headerText="#{msg['sellingPrice']}" sortBy="${item.sellingPrice}">
                            <p:cellEditor>
                                <f:facet name="output">
                                    <h:outputText value="$${item.sellingPrice}">
                                        <f:convertNumber minFractionDigits="2" maxFractionDigits="2"/>
                                    </h:outputText>
                                </f:facet>
                                <f:facet name="input">
                                    <p:spinner min="0" stepFactor="1" value="${item.sellingPrice}" prefix="$">
                                        <f:convertNumber minFractionDigits="2" maxFractionDigits="2"
                                                         groupingUsed="false"/>
                                    </p:spinner>
                                </f:facet>
                            </p:cellEditor>
                        </p:column>

                        <p:column style="width:32px">
                            <p:rowEditor/>
                        </p:column>
                    </p:dataTable>
                </h:form>

                <br/>

                <h:form id="addParcelForm">
                    <p:panelGrid columns="2" cellpadding="5">
                        <f:facet name="header">
                            <h3>#{msg['parcelInfo']}</h3>
                        </f:facet>

                        <p:outputLabel value="#{msg['deliveryCost']}:"/>
                        <p:spinner min="0" stepFactor="1" value="${parcelBean.parcel.deliveryCost}" prefix="$">
                            <f:convertNumber minFractionDigits="2" maxFractionDigits="2" groupingUsed="false"/>
                        </p:spinner>

                        <p:outputLabel value="#{msg['numberOfItems']}:"/>
                        <p:outputLabel id="numberOfItems" value="${parcelBean.parcel.items.size()}"/>

                        <f:facet name="footer">
                            <p:commandButton styleClass="add-parcel-button" value="#{msg['save']}"
                                             action="${parcelBean.saveParcel()}"
                                             update="addParcelForm, :itemsEditable, :addItemForm"/>
                        </f:facet>
                    </p:panelGrid>
                </h:form>
            </div>

            <p:commandButton id="edit-parcel" value="#{msg['editParcel']}"/>

            <div id="parcel-editing">
                <h:form>
                    <p:dataTable var="parcel" value="${parcelsBean.parcels}" editable="true">
                        <f:facet name="header">
                            <h3>#{msg['parcels']}</h3>
                        </f:facet>
                        <p:column headerText="#{msg['id']}" sortBy="${parcel.id}">
                            <h:outputText value="${parcel.id}"/>
                        </p:column>

                        <p:column headerText="#{msg['datePurchased']}" sortBy="${parcel.purchased}">
                            <h:outputText value="${parcel.purchased}">
                                <f:convertDateTime pattern="dd.MM.yyyy HH:mm"/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="#{msg['parcelStatus']}">
                            <p:cellEditor>
                                <f:facet name="output">
                                    <h:outputText value="#{msg[parcel.status.label]}"/>
                                </f:facet>
                                <f:facet name="input">
                                    <p:selectOneMenu value="${parcel.status}">
                                        <f:selectItems value="${parcelsBean.parcelStatuses}" var="status"
                                                       itemValue="${status}"
                                                       itemLabel="#{msg[status.label]}"/>
                                    </p:selectOneMenu>
                                </f:facet>
                            </p:cellEditor>
                        </p:column>

                        <p:column headerText="#{msg['numberOfItems']}" sortBy="${parcel.items.size()}">
                            <h:outputText value="${parcel.items.size()}"/>
                        </p:column>

                        <p:column headerText="#{msg['deliveryCost']}" sortBy="${parcel.deliveryCost}">
                            <p:cellEditor>
                                <f:facet name="output">
                                    <h:outputText value="$${parcel.deliveryCost}"/>
                                </f:facet>
                                <f:facet name="input">
                                    <p:spinner min="0" stepFactor="1" value="${parcel.deliveryCost}" prefix="$">
                                        <f:convertNumber minFractionDigits="2" maxFractionDigits="2"
                                                         groupingUsed="false"/>
                                    </p:spinner>
                                </f:facet>
                            </p:cellEditor>
                        </p:column>

                        <p:column style="width:32px">
                            <p:rowEditor/>
                        </p:column>

                        <p:column>
                            <p:commandButton id="edit-parcel-items" value="#{msg['editItems']}"
                                             action="${itemsBean.loadItemsForParcel(parcel)}"
                                             update=":parcelItemsEditable" onclick="$('#parcel-item-editing').show()"/>
                        </p:column>
                    </p:dataTable>
                </h:form>

                <br/>

                <div id="parcel-item-editing">
                    <h:form id="parcelItemsEditable">
                        <p:dataTable var="item" value="${itemsBean.items}" editable="true">
                            <f:facet name="header">
                                <h3>#{msg['parcelItems']}</h3>
                            </f:facet>
                            <p:column headerText="#{msg['name']}" sortBy="${item.nameBought}">
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="${item.nameBought}"/>
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:inputText value="${item.nameBought}"/>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="#{msg['weight']}" sortBy="${item.weightBought}">
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="${item.weightBought}">
                                            <f:convertNumber minFractionDigits="1" maxFractionDigits="1"/>
                                        </h:outputText>
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:spinner min="0" stepFactor="0.1" value="${item.weightBought}"
                                                   suffix=" #{msg['t']}"/>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="#{msg['description']}" sortBy="${item.descriptionBought}">
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="${item.descriptionBought}"/>
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:inputText value="${item.descriptionBought}"/>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="#{msg['buyingPrice']}" sortBy="${item.buyingPrice}">
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="$${item.buyingPrice}">
                                            <f:convertNumber minFractionDigits="2" maxFractionDigits="2"/>
                                        </h:outputText>
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:spinner min="0" stepFactor="1" value="${item.buyingPrice}" prefix="$">
                                            <f:convertNumber minFractionDigits="2" maxFractionDigits="2"
                                                             groupingUsed="false"/>
                                        </p:spinner>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="#{msg['sellingPrice']}" sortBy="${item.sellingPrice}">
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="$${item.sellingPrice}">
                                            <f:convertNumber minFractionDigits="2" maxFractionDigits="2"/>
                                        </h:outputText>
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:spinner min="0" stepFactor="1" value="${item.sellingPrice}" prefix="$">
                                            <f:convertNumber minFractionDigits="2" maxFractionDigits="2"
                                                             groupingUsed="false"/>
                                        </p:spinner>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column style="width:32px">
                                <p:rowEditor/>
                            </p:column>
                        </p:dataTable>
                    </h:form>
                </div>

                <p:commandButton styleClass="save-parcel-changes-button" action="${parcelsBean.saveChanges()}"
                                 value="#{msg['saveChanges']}"/>
            </div>
        </sec:authorize>

        <sec:authorize ifAllGranted="COLD_STORE_MANAGER">
            <p:commandButton id="register-parcel-cs" value="#{msg['registerParcel']}"/>

            <div id="parcel-registration-cs">
                <p:dataTable id="parcelsTable" var="parcel" value="${parcelsBean.parcels}">
                    <f:facet name="header">
                        <h3>#{msg['parcels']}</h3>
                    </f:facet>
                    <p:column headerText="#{msg['id']}" sortBy="${parcel.id}">
                        <h:outputText value="${parcel.id}"/>
                    </p:column>

                    <p:column headerText="#{msg['datePurchased']}" sortBy="${parcel.purchased}">
                        <h:outputText value="${parcel.purchased}">
                            <f:convertDateTime pattern="dd.MM.yyyy HH:mm"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="#{msg['parcelStatus']}">
                        <h:outputText value="#{msg[parcel.status.label]}"/>
                    </p:column>

                    <p:column headerText="#{msg['numberOfItems']}" sortBy="${parcel.items.size()}">
                        <h:outputText value="${parcel.items.size()}"/>
                    </p:column>

                    <p:column>
                        <p:commandButton id="edit-parcel-items-cs" value="#{msg['editItems']}"
                                         action="${itemsBean.loadItemsForParcelForEditingByCsm(parcel)}"
                                         update=":parcelItemsEditable-cs"
                                         onclick="$('#parcel-item-editing-cs').show()"/>
                    </p:column>
                </p:dataTable>

                <br/>

                <div id="parcel-item-editing-cs">
                    <h:form id="parcelItemsEditable-cs">
                        <p:dataTable var="item" value="${itemsBean.items}" editable="true">
                            <f:facet name="header">
                                <h3>#{msg['parcelItems']}</h3>
                            </f:facet>
                            <p:column headerText="#{msg['name']}" sortBy="${item.nameColdStore}">
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="${item.nameColdStore}"/>
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:inputText value="${item.nameColdStore}"/>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="#{msg['weight']}" sortBy="${item.weightColdStore}">
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="${item.weightColdStore}">
                                            <f:convertNumber minFractionDigits="1" maxFractionDigits="1"/>
                                        </h:outputText>
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:spinner min="0" stepFactor="0.1" value="${item.weightColdStore}"
                                                   suffix=" #{msg['t']}"/>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="#{msg['description']}" sortBy="${item.descriptionColdStore}">
                                <p:cellEditor>
                                    <f:facet name="output">
                                        <h:outputText value="${item.descriptionColdStore}"/>
                                    </f:facet>
                                    <f:facet name="input">
                                        <p:inputText value="${item.descriptionColdStore}"/>
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column style="width:32px">
                                <p:rowEditor/>
                            </p:column>

                            <f:facet name="footer">
                                <p:commandButton styleClass="save-parcel-changes-button" action="${itemsBean.saveChangesColdStore()}"
                                                 value="#{msg['registerParcel']}" update=":parcelsTable"
                                                 onclick="$('#parcel-item-editing-cs').hide()"/>
                            </f:facet>
                        </p:dataTable>
                    </h:form>
                </div>
            </div>

            <p:commandButton id="register-order-shipment" value="#{msg['registerOrderShipment']}"/>

            <div id="order-shipment-registration">
                <p:dataTable id="ordersPendingShipmentTable" var="order" value="${ordersBean.ordersPendingShipment}">
                    <f:facet name="header">
                        <h3>#{msg['ordersPendingShipment']}</h3>
                    </f:facet>

                    <p:column headerText="#{msg['id']}">
                        <h:outputText value="${order.id}"/>
                    </p:column>

                    <p:column headerText="#{msg['dateOrdered']}">
                        <h:outputText value="${order.created}">
                            <f:convertDateTime pattern="dd.MM.yyyy HH:mm"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="#{msg['shippingAddress']}">
                        <h:outputText value="${order.customer.shippingAddress}"/>
                    </p:column>

                    <p:column headerText="#{msg['numberOfOrderedItems']}">
                        <h:outputText value="${order.orderedItems.size()}"/>
                    </p:column>

                    <p:column>
                        <p:commandButton value="#{msg['markAsShipped']}"
                                         action="${ordersBean.markOrderAsShipped(order)}"
                                         update="ordersPendingShipmentTable"/>
                    </p:column>
                </p:dataTable>
            </div>
        </sec:authorize>

        <sec:authorize ifAllGranted="ACCOUNTANT">
            <p:commandButton id="register-payment" value="#{msg['registerPayment']}"/>

            <div id="payment-registration">
                <p:dataTable id="ordersPendingPaymentsTable" var="order" value="${ordersBean.ordersPendingPayments}">
                    <f:facet name="header">
                        <h3>#{msg['incompleteOrders']}</h3>
                    </f:facet>

                    <p:column headerText="#{msg['id']}">
                        <h:outputText value="${order.id}"/>
                    </p:column>

                    <p:column headerText="#{msg['dateOrdered']}">
                        <h:outputText value="${order.created}">
                            <f:convertDateTime pattern="dd.MM.yyyy HH:mm"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="#{msg['orderStatus']}">
                        <h:outputText value="#{msg[order.status.label]}"/>
                    </p:column>

                    <p:column headerText="#{msg['customerName']}">
                        <h:outputText value="${order.customer.name}"/>
                    </p:column>

                    <p:column headerText="#{msg['prepaymentShareRequired']}">
                        <h:outputText value="${order.customer.prepaymentShareRequired * 100}">
                            <f:convertNumber minFractionDigits="1" maxFractionDigits="1"/>
                        </h:outputText>
                        <h:outputText value="% ($"/>
                        <h:outputText value="${order.requiredPrepaymentSum}">
                            <f:convertNumber minFractionDigits="2" maxFractionDigits="2"/>
                        </h:outputText>
                        <h:outputText value=")"/>
                    </p:column>

                    <p:column headerText="#{msg['paid']}">
                        <h:outputText value="${order.percentagePaid}">
                            <f:convertNumber minFractionDigits="1" maxFractionDigits="1"/>
                        </h:outputText>
                        <h:outputText value="% ($"/>
                        <h:outputText value="${order.totalPaymentSum}">
                            <f:convertNumber minFractionDigits="2" maxFractionDigits="2"/>
                        </h:outputText>
                        <h:outputText value=")"/>
                    </p:column>

                    <p:column headerText="#{msg['numberOfPayments']}">
                        <h:outputText value="${order.payments.size()}"/>
                    </p:column>

                    <p:column>
                        <p:commandButton value="#{msg['addPayment']}" onclick="$(this).parent().find('.add-payment').toggle()"/>

                        <div class="add-payment">
                            <h:form>
                                <p:spinner min="0" max="${order.totalPrice}" stepFactor="1" prefix="$"
                                           value="${ordersBean.sum}" size="5"/>
                                <p:commandButton value="#{msg['save']}" action="${ordersBean.addPaymentToOrder(order)}"
                                                 onclick="$('#add-payment').hide()"
                                                 update=":ordersPendingPaymentsTable"/>
                            </h:form>
                        </div>

                        <p:commandButton rendered="${order.status == 'PENDING_PREPAYMENT'}"
                                         value="#{msg['markAsReadyForShipment']}"
                                         action="${ordersBean.markOrderAsReadyForShipment(order)}"
                                         update=":ordersPendingPaymentsTable"/>

                        <p:commandButton rendered="${order.status == 'SHIPPED'}"
                                         value="#{msg['markAsCompleted']}"
                                         action="${ordersBean.markOrderAsCompleted(order)}"
                                         update=":ordersPendingPaymentsTable"/>
                    </p:column>

                </p:dataTable>
            </div>
        </sec:authorize>

        <sec:authorize ifAllGranted="SECURITY_OFFICER">

        </sec:authorize>
    </ui:define>
</ui:composition>
</html>
